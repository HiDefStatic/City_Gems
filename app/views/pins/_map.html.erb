<!-- <!DOCTYPE html> -->
<!-- <html>
<head>
    <meta charset='utf-8' />
    <title></title> -->
    <div id="map-placeholder">
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />

    <style>
        body { margin:0; padding:0; }
        #map-placeholder { position:relative;  }
    </style>
</head>
<body>

<style>

#marker {
    background-image: url('https://www.mapbox.com/mapbox-gl-js/assets/washington-monument.jpg');
    background-size: cover;
    width: 50px;
    height: 50px;
    border-radius: 50%;
    cursor: pointer;
}

.mapboxgl-popup {
    max-width: 200px;
}

</style>

<!-- <div id="map-placeholder"> -->
  <script>

var pins = <%== @pins.to_json %>;//nifty way to get Ruby info as json

mapboxgl.accessToken = "<%== ENV['MAPBOX_API_KEY'] %>";
var map = new mapboxgl.Map({
    container: 'map-placeholder', // container id
    style: 'mapbox://styles/mapbox/streets-v9', //stylesheet location
    center: [-122.3321, 47.6062], // starting position
    zoom: 11 // starting zoom
});

map.addControl(new MapboxGeocoder({
  accessToken: mapboxgl.accessToken
})); //creates search bar

map.addControl(new mapboxgl.GeolocateControl()); //creates 'my location' button

///////////////////////////////////////////////////////////////////////////////

map.on('load', function(){

  var pinFeatures = pins.map(function(pin){
    return {
      "type": "Feature",
      "properties": {
        name: pin.name
      },
      "geometry": {
          "type": "Point",
          "coordinates": [
              pin.lng,
               pin.lat
          ]
      }
    };
  }); //the above creates the pins

  map.addSource('pins', {
   type: 'geojson',
   data: {
     "type": "FeatureCollection",
       "features": pinFeatures
    }
  });

  map.addLayer({
    id:"pins",
    type: "symbol",
    source: "pins",
    layout: {
      "icon-image": "star-15",
      "icon-allow-overlap": true
    }

  })
});



map.on('click', function(event) {
  var popup = new mapboxgl.Popup({offset: 25})
    .setText('Construction on the Washington Monument began in 1848.');

  var el = document.createElement('div');
  var marker = new mapboxgl.Marker(el)
  .setLngLat(event.lngLat)
  .addTo(map);

  map.getLayer({
    id:"pins",
    type: "symbol",
    source: "pins",
    layout: {
      "icon-image": "star-15",
      "icon-allow-overlap": true
    }
  })

  map.getSource('pins').setData({
    type: 'FeatureCollection',
    features: [{
        "type": "Feature",
        properties: {},
        "geometry": {
          type: "Point",
          coordinates: [marker._lngLat.lng, marker._lngLat.lat]
        }
     }]
   });
});

var popup = new mapboxgl.Popup({offset: 25})
    .setText('Construction on the Washington Monument began in 1848.');


</script> <!-- end of base map -->

</div>
